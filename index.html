<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Pomo ‚Äî Í∞êÏÑ± Ìè¨Î™®ÎèÑÎ°ú</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600&family=Noto+Sans+KR:wght@300;400;500&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-primary: #1a1a2e;
  --bg-secondary: rgba(255,255,255,0.06);
  --text-primary: #f0e6d3;
  --text-secondary: rgba(240,230,211,0.5);
  --accent: #e8a87c;
  --accent-glow: rgba(232,168,124,0.3);
  --timer-size: min(320px, 70vw);
  --radius: 20px;
  --font-display: 'Outfit', sans-serif;
  --font-body: 'Outfit', 'Noto Sans KR', 'Noto Sans SC', sans-serif;
  --transition: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

/* === THEMES === */
[data-theme="lofi"] {
  --bg-primary: #1a1a2e;
  --bg-secondary: rgba(255,255,255,0.06);
  --text-primary: #f0e6d3;
  --text-secondary: rgba(240,230,211,0.5);
  --accent: #e8a87c;
  --accent-glow: rgba(232,168,124,0.3);
}
[data-theme="sunset"] {
  --bg-primary: #2d1b3d;
  --bg-secondary: rgba(255,255,255,0.08);
  --text-primary: #fde8d0;
  --text-secondary: rgba(253,232,208,0.5);
  --accent: #f0836d;
  --accent-glow: rgba(240,131,109,0.35);
}
[data-theme="forest"] {
  --bg-primary: #1a2a1a;
  --bg-secondary: rgba(255,255,255,0.06);
  --text-primary: #e0ead4;
  --text-secondary: rgba(224,234,212,0.5);
  --accent: #8fbc8f;
  --accent-glow: rgba(143,188,143,0.3);
}

html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: background var(--transition), color var(--transition);
  -webkit-font-smoothing: antialiased;
}

/* === ANIMATED BACKGROUND === */
.bg-layer {
  position: fixed; inset: 0; z-index: 0;
  transition: opacity var(--transition);
}

/* Lofi: starry night gradient */
[data-theme="lofi"] .bg-layer {
  background: 
    radial-gradient(ellipse at 20% 50%, rgba(99,71,130,0.4) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, rgba(58,80,120,0.4) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 100%, rgba(30,30,60,0.6) 0%, transparent 60%),
    linear-gradient(180deg, #0f0f23 0%, #1a1a2e 40%, #16213e 100%);
}

/* Sunset: warm dusk */
[data-theme="sunset"] .bg-layer {
  background:
    radial-gradient(ellipse at 50% 110%, rgba(240,131,109,0.25) 0%, transparent 55%),
    radial-gradient(ellipse at 80% 30%, rgba(180,80,120,0.3) 0%, transparent 50%),
    radial-gradient(ellipse at 20% 60%, rgba(100,40,80,0.3) 0%, transparent 50%),
    linear-gradient(180deg, #1a0f25 0%, #2d1b3d 50%, #3d1f3f 100%);
}

/* Forest: deep greens */
[data-theme="forest"] .bg-layer {
  background:
    radial-gradient(ellipse at 30% 70%, rgba(60,100,60,0.3) 0%, transparent 55%),
    radial-gradient(ellipse at 70% 30%, rgba(40,80,50,0.3) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 100%, rgba(20,40,20,0.5) 0%, transparent 60%),
    linear-gradient(180deg, #0f1a0f 0%, #1a2a1a 50%, #1f301f 100%);
}

/* Floating particles */
.particles {
  position: fixed; inset: 0; z-index: 1;
  overflow: hidden; pointer-events: none;
}
.particle {
  position: absolute;
  width: 3px; height: 3px;
  background: var(--text-primary);
  border-radius: 50%;
  opacity: 0;
  animation: float-up linear infinite;
}
@keyframes float-up {
  0% { opacity: 0; transform: translateY(0) scale(0.5); }
  10% { opacity: 0.4; }
  90% { opacity: 0.1; }
  100% { opacity: 0; transform: translateY(-100vh) scale(0); }
}

/* === MAIN LAYOUT === */
.app {
  position: relative; z-index: 10;
  width: 100%; height: 100%;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 20px;
}

/* === TOP BAR === */
.top-bar {
  position: fixed; top: 0; left: 0; right: 0;
  z-index: 100;
  display: flex; justify-content: space-between; align-items: center;
  padding: 16px 24px;
}
.lang-switcher {
  display: flex; gap: 4px;
  background: var(--bg-secondary);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 10px;
  padding: 4px;
}
.lang-btn {
  background: none; border: none;
  color: var(--text-secondary);
  font-family: var(--font-body);
  font-size: 12px; font-weight: 500;
  padding: 6px 12px;
  border-radius: 7px;
  cursor: pointer;
  transition: all 0.3s ease;
  letter-spacing: 0.02em;
}
.lang-btn.active {
  background: var(--accent);
  color: var(--bg-primary);
}
.theme-switcher {
  display: flex; gap: 6px;
  background: var(--bg-secondary);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 10px;
  padding: 6px 10px;
}
.theme-dot {
  width: 18px; height: 18px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}
.theme-dot::after {
  content: '';
  position: absolute; inset: 2px;
  border-radius: 50%;
}
.theme-dot[data-t="lofi"]::after { background: linear-gradient(135deg, #667eea, #764ba2); }
.theme-dot[data-t="sunset"]::after { background: linear-gradient(135deg, #f0836d, #c06080); }
.theme-dot[data-t="forest"]::after { background: linear-gradient(135deg, #6dbb6d, #3a7a3a); }
.theme-dot.active { border-color: var(--text-primary); transform: scale(1.15); }

/* === MODE TABS === */
.mode-tabs {
  display: flex; gap: 4px;
  background: var(--bg-secondary);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 14px;
  padding: 5px;
  margin-bottom: 40px;
}
.mode-tab {
  background: none; border: none;
  color: var(--text-secondary);
  font-family: var(--font-body);
  font-size: 13px; font-weight: 400;
  padding: 10px 22px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.35s ease;
  white-space: nowrap;
}
.mode-tab.active {
  background: rgba(255,255,255,0.1);
  color: var(--text-primary);
  font-weight: 500;
}

/* === TIMER === */
.timer-container {
  position: relative;
  width: var(--timer-size); height: var(--timer-size);
  margin-bottom: 40px;
}
.timer-ring {
  position: absolute; inset: 0;
}
.timer-ring svg {
  width: 100%; height: 100%;
  transform: rotate(-90deg);
}
.timer-ring-bg {
  fill: none;
  stroke: var(--bg-secondary);
  stroke-width: 3;
}
.timer-ring-progress {
  fill: none;
  stroke: var(--accent);
  stroke-width: 3;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.5s linear, stroke var(--transition);
  filter: drop-shadow(0 0 8px var(--accent-glow));
}
.timer-display {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 4px;
}
.timer-time {
  font-family: var(--font-display);
  font-size: clamp(52px, 12vw, 80px);
  font-weight: 200;
  letter-spacing: 4px;
  line-height: 1;
  color: var(--text-primary);
  transition: color var(--transition);
}
.timer-label {
  font-size: 12px;
  font-weight: 400;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--text-secondary);
  transition: color var(--transition);
}

/* Glow effect when running */
.timer-container.running .timer-time {
  text-shadow: 0 0 40px var(--accent-glow);
}

/* Pulse animation on break */
.timer-container.on-break .timer-ring-progress {
  animation: pulse-ring 2s ease-in-out infinite;
}
@keyframes pulse-ring {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* === START BUTTON === */
.start-btn {
  background: none;
  border: 1.5px solid rgba(255,255,255,0.15);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 15px;
  font-weight: 400;
  letter-spacing: 4px;
  text-transform: uppercase;
  padding: 16px 52px;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.4s ease;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  margin-bottom: 36px;
}
.start-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  box-shadow: 0 0 30px var(--accent-glow);
  transform: translateY(-1px);
}
.start-btn:active {
  transform: translateY(0) scale(0.98);
}

/* === SOUND CONTROL === */
.sound-control {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg-secondary);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 12px;
  padding: 8px 14px;
}
.sound-icon {
  width: 18px; height: 18px;
  color: var(--text-secondary);
  flex-shrink: 0;
}
.sound-select {
  background: none; border: none;
  color: var(--text-secondary);
  font-family: var(--font-body);
  font-size: 12px;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  padding-right: 16px;
  position: relative;
  outline: none;
}
.sound-select option {
  background: #1a1a2e;
  color: #f0e6d3;
}
.sound-vol {
  -webkit-appearance: none;
  appearance: none;
  width: 60px; height: 3px;
  background: rgba(255,255,255,0.15);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}
.sound-vol::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px; height: 12px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
}

/* === POMODORO COUNT === */
.pomo-count {
  position: fixed;
  bottom: 24px; left: 50%;
  transform: translateX(-50%);
  display: flex; align-items: center; gap: 8px;
  color: var(--text-secondary);
  font-size: 12px;
  letter-spacing: 1px;
}
.pomo-dots {
  display: flex; gap: 6px;
}
.pomo-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--bg-secondary);
  transition: all 0.4s ease;
}
.pomo-dot.filled {
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent-glow);
}

/* === SESSION COMPLETE ANIMATION === */
.session-flash {
  position: fixed; inset: 0;
  background: var(--accent);
  opacity: 0;
  z-index: 200;
  pointer-events: none;
  transition: opacity 0.15s ease;
}
.session-flash.active {
  opacity: 0.15;
}

/* === RESPONSIVE === */
@media (max-width: 480px) {
  .top-bar { padding: 12px 16px; }
  .lang-btn { font-size: 11px; padding: 5px 10px; }
  .theme-dot { width: 16px; height: 16px; }
  .mode-tab { padding: 8px 16px; font-size: 12px; }
  .start-btn { padding: 14px 40px; font-size: 13px; letter-spacing: 3px; }
  .timer-container { margin-bottom: 30px; }
  .mode-tabs { margin-bottom: 28px; }
}

/* === FADE IN === */
.app { animation: fadeIn 1s ease-out; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Selection color */
::selection {
  background: var(--accent);
  color: var(--bg-primary);
}
</style>
</head>
<body data-theme="lofi">

<div class="bg-layer"></div>
<div class="particles" id="particles"></div>
<div class="session-flash" id="sessionFlash"></div>

<!-- Top Bar -->
<div class="top-bar">
  <div class="lang-switcher">
    <button class="lang-btn active" data-lang="ko">ÌïúÍµ≠Ïñ¥</button>
    <button class="lang-btn" data-lang="en">EN</button>
    <button class="lang-btn" data-lang="zh">‰∏≠Êñá</button>
  </div>
  <div class="theme-switcher">
    <div class="theme-dot active" data-t="lofi" title="Lofi Night"></div>
    <div class="theme-dot" data-t="sunset" title="Sunset"></div>
    <div class="theme-dot" data-t="forest" title="Forest"></div>
  </div>
</div>

<!-- Main App -->
<div class="app">
  <!-- Mode Tabs -->
  <div class="mode-tabs">
    <button class="mode-tab active" data-mode="focus" data-i18n="focus">ÏßëÏ§ë</button>
    <button class="mode-tab" data-mode="short" data-i18n="shortBreak">ÏßßÏùÄ Ìú¥Ïãù</button>
    <button class="mode-tab" data-mode="long" data-i18n="longBreak">Í∏¥ Ìú¥Ïãù</button>
  </div>

  <!-- Timer -->
  <div class="timer-container" id="timerContainer">
    <div class="timer-ring">
      <svg viewBox="0 0 320 320">
        <circle class="timer-ring-bg" cx="160" cy="160" r="150"/>
        <circle class="timer-ring-progress" id="ringProgress" cx="160" cy="160" r="150"
                stroke-dasharray="942.48" stroke-dashoffset="0"/>
      </svg>
    </div>
    <div class="timer-display">
      <div class="timer-time" id="timerTime">25:00</div>
      <div class="timer-label" id="timerLabel" data-i18n="ready">Ï§ÄÎπÑ</div>
    </div>
  </div>

  <!-- Start Button -->
  <button class="start-btn" id="startBtn" data-i18n="start">ÏãúÏûë</button>

  <!-- Sound Control -->
  <div class="sound-control">
    <svg class="sound-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M9 18V6l7-3v18l-7-3z"/><path d="M9 12H4m0-3v6"/>
    </svg>
    <select class="sound-select" id="soundSelect">
      <option value="none" data-i18n-opt="soundNone">Î¨¥Ïùå</option>
      <option value="rain" data-i18n-opt="soundRain">ÎπóÏÜåÎ¶¨</option>
      <option value="cafe" data-i18n-opt="soundCafe">Ïπ¥Ìéò</option>
    </select>
    <input type="range" class="sound-vol" id="soundVol" min="0" max="100" value="40">
  </div>
</div>

<!-- Pomodoro Count -->
<div class="pomo-count">
  <div class="pomo-dots" id="pomoDots">
    <div class="pomo-dot"></div>
    <div class="pomo-dot"></div>
    <div class="pomo-dot"></div>
    <div class="pomo-dot"></div>
  </div>
  <span id="pomoCountText">0 / 4</span>
</div>

<!-- Alarm sound (short beep generated via Web Audio API) -->
<script>
// ============================================
//  i18n
// ============================================
const i18n = {
  ko: {
    focus: 'ÏßëÏ§ë', shortBreak: 'ÏßßÏùÄ Ìú¥Ïãù', longBreak: 'Í∏¥ Ìú¥Ïãù',
    start: 'ÏãúÏûë', pause: 'ÏùºÏãúÏ†ïÏßÄ', resume: 'Í≥ÑÏÜç',
    ready: 'Ï§ÄÎπÑ', focusing: 'ÏßëÏ§ë Ï§ë', breaking: 'Ìú¥Ïãù Ï§ë',
    soundNone: 'Î¨¥Ïùå', soundRain: 'ÎπóÏÜåÎ¶¨', soundCafe: 'Ïπ¥Ìéò',
    sessionDone: 'ÏÑ∏ÏÖò ÏôÑÎ£å!', breakDone: 'Ìú¥Ïãù ÎÅù! Îã§Ïãú ÏßëÏ§ëÌïòÏÑ∏Ïöî',
    tabFocus: 'ÏßëÏ§ë Ï§ë', tabBreak: 'Ìú¥Ïãù Ï§ë',
  },
  en: {
    focus: 'Focus', shortBreak: 'Short Break', longBreak: 'Long Break',
    start: 'Start', pause: 'Pause', resume: 'Resume',
    ready: 'Ready', focusing: 'Focusing', breaking: 'On Break',
    soundNone: 'Silent', soundRain: 'Rain', soundCafe: 'Caf√©',
    sessionDone: 'Session done!', breakDone: 'Break over! Time to focus',
    tabFocus: 'Focus', tabBreak: 'Break',
  },
  zh: {
    focus: '‰∏ìÊ≥®', shortBreak: 'Áü≠‰ºëÊÅØ', longBreak: 'Èïø‰ºëÊÅØ',
    start: 'ÂºÄÂßã', pause: 'ÊöÇÂÅú', resume: 'ÁªßÁª≠',
    ready: 'ÂáÜÂ§á', focusing: '‰∏ìÊ≥®‰∏≠', breaking: '‰ºëÊÅØ‰∏≠',
    soundNone: 'ÈùôÈü≥', soundRain: 'Èõ®Â£∞', soundCafe: 'ÂíñÂï°ÂéÖ',
    sessionDone: 'ÂÆåÊàêÔºÅ', breakDone: '‰ºëÊÅØÁªìÊùüÔºÅÁªßÁª≠‰∏ìÊ≥®',
    tabFocus: '‰∏ìÊ≥®', tabBreak: '‰ºëÊÅØ',
  }
};

let currentLang = 'ko';
const originalTitle = 'Pomo';

function t(key) { return i18n[currentLang][key] || key; }

function updateUI() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (i18n[currentLang][key]) el.textContent = i18n[currentLang][key];
  });
  document.querySelectorAll('[data-i18n-opt]').forEach(el => {
    const key = el.getAttribute('data-i18n-opt');
    if (i18n[currentLang][key]) el.textContent = i18n[currentLang][key];
  });
  // Update dynamic labels
  if (!isRunning) {
    timerLabel.textContent = t('ready');
    startBtn.textContent = t('start');
    document.title = originalTitle;
  } else {
    updateTimerLabel();
    startBtn.textContent = t('pause');
  }
  if (isPaused) startBtn.textContent = t('resume');
}

// ============================================
//  State
// ============================================
const MODES = {
  focus: 25 * 60,
  short: 5 * 60,
  long: 15 * 60,
};

let currentMode = 'focus';
let timeLeft = MODES.focus;
let totalTime = MODES.focus;
let isRunning = false;
let isPaused = false;
let intervalId = null;
let pomoCount = 0;

// DOM
const timerTime = document.getElementById('timerTime');
const timerLabel = document.getElementById('timerLabel');
const timerContainer = document.getElementById('timerContainer');
const startBtn = document.getElementById('startBtn');
const ringProgress = document.getElementById('ringProgress');
const pomoDots = document.getElementById('pomoDots');
const pomoCountText = document.getElementById('pomoCountText');
const sessionFlash = document.getElementById('sessionFlash');
const circumference = 2 * Math.PI * 150; // 942.48

ringProgress.style.strokeDasharray = circumference;

// ============================================
//  Timer Logic
// ============================================
function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

function updateDisplay() {
  timerTime.textContent = formatTime(timeLeft);
  const progress = 1 - (timeLeft / totalTime);
  ringProgress.style.strokeDashoffset = circumference * (1 - progress);
  // Tab title
  if (isRunning && !isPaused) {
    const modeLabel = currentMode === 'focus' ? t('tabFocus') : t('tabBreak');
    document.title = `${formatTime(timeLeft)} ‚Äî ${modeLabel}`;
  }
}

function updateTimerLabel() {
  if (currentMode === 'focus') {
    timerLabel.textContent = t('focusing');
    timerLabel.setAttribute('data-i18n', 'focusing');
  } else {
    timerLabel.textContent = t('breaking');
    timerLabel.setAttribute('data-i18n', 'breaking');
  }
}

function startTimer() {
  if (isPaused) {
    isPaused = false;
    isRunning = true;
    startBtn.textContent = t('pause');
    intervalId = setInterval(tick, 1000);
    return;
  }
  if (isRunning) {
    // Pause
    isPaused = true;
    isRunning = false;
    clearInterval(intervalId);
    startBtn.textContent = t('resume');
    document.title = `‚è∏ ${formatTime(timeLeft)} ‚Äî ${originalTitle}`;
    return;
  }
  // Start fresh
  isRunning = true;
  isPaused = false;
  startBtn.textContent = t('pause');
  timerContainer.classList.add('running');
  if (currentMode !== 'focus') timerContainer.classList.add('on-break');
  updateTimerLabel();
  intervalId = setInterval(tick, 1000);
}

function tick() {
  timeLeft--;
  updateDisplay();
  if (timeLeft <= 0) {
    clearInterval(intervalId);
    isRunning = false;
    isPaused = false;
    timerContainer.classList.remove('running', 'on-break');
    // Flash effect
    sessionFlash.classList.add('active');
    setTimeout(() => sessionFlash.classList.remove('active'), 400);
    playAlarm();
    if (currentMode === 'focus') {
      pomoCount++;
      updatePomoDots();
      notify(t('sessionDone'));
      // Auto switch to break
      if (pomoCount % 4 === 0) {
        switchMode('long');
      } else {
        switchMode('short');
      }
    } else {
      notify(t('breakDone'));
      switchMode('focus');
    }
    startBtn.textContent = t('start');
    timerLabel.textContent = t('ready');
    document.title = originalTitle;
  }
}

function switchMode(mode) {
  currentMode = mode;
  timeLeft = MODES[mode];
  totalTime = MODES[mode];
  clearInterval(intervalId);
  isRunning = false;
  isPaused = false;
  timerContainer.classList.remove('running', 'on-break');
  updateDisplay();
  // Update active tab
  document.querySelectorAll('.mode-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.mode === mode);
  });
  startBtn.textContent = t('start');
  timerLabel.textContent = t('ready');
  document.title = originalTitle;
}

function updatePomoDots() {
  const dots = pomoDots.querySelectorAll('.pomo-dot');
  const cycleCount = pomoCount % 4;
  dots.forEach((dot, i) => {
    dot.classList.toggle('filled', i < (cycleCount === 0 && pomoCount > 0 ? 4 : cycleCount));
  });
  pomoCountText.textContent = `${pomoCount} / ${Math.ceil(pomoCount / 4) * 4 || 4}`;
  // Reset dots display after showing all 4 filled briefly
  if (cycleCount === 0 && pomoCount > 0) {
    setTimeout(() => {
      dots.forEach(d => d.classList.remove('filled'));
      pomoCountText.textContent = `${pomoCount}`;
    }, 2000);
  }
}

// ============================================
//  Audio: Alarm
// ============================================
let audioCtx;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playAlarm() {
  try {
    const ctx = getAudioCtx();
    const now = ctx.currentTime;
    // Gentle two-tone chime
    [440, 554, 659].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0, now + i * 0.3);
      gain.gain.linearRampToValueAtTime(0.15, now + i * 0.3 + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.3 + 0.8);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now + i * 0.3);
      osc.stop(now + i * 0.3 + 0.8);
    });
  } catch(e) {}
}

// ============================================
//  Audio: Background sounds (generated)
// ============================================
let bgAudioCtx, bgNodes = {}, currentSound = 'none';

function createBgAudio() {
  if (bgAudioCtx) return;
  bgAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function generateNoise(type) {
  createBgAudio();
  stopBgSound();
  if (type === 'none') { currentSound = 'none'; return; }

  const ctx = bgAudioCtx;
  const bufferSize = ctx.sampleRate * 4;
  const buffer = ctx.createBuffer(2, bufferSize, ctx.sampleRate);
  const gainNode = ctx.createGain();
  const vol = document.getElementById('soundVol').value / 100;
  gainNode.gain.value = vol * 0.3;

  if (type === 'rain') {
    // Brown noise (rain-like)
    for (let ch = 0; ch < 2; ch++) {
      const data = buffer.getChannelData(ch);
      let last = 0;
      for (let i = 0; i < bufferSize; i++) {
        const white = Math.random() * 2 - 1;
        data[i] = (last + (0.02 * white)) / 1.02;
        last = data[i];
        data[i] *= 3.5;
      }
    }
    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 800;
    const source = ctx.createBufferSource();
    source.buffer = buffer;
    source.loop = true;
    source.connect(filter);
    filter.connect(gainNode);
    gainNode.connect(ctx.destination);
    source.start();
    bgNodes = { source, filter, gain: gainNode };
  } else if (type === 'cafe') {
    // Pink noise (cafe ambience)
    for (let ch = 0; ch < 2; ch++) {
      const data = buffer.getChannelData(ch);
      let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
      for (let i = 0; i < bufferSize; i++) {
        const white = Math.random() * 2 - 1;
        b0 = 0.99886*b0 + white*0.0555179;
        b1 = 0.99332*b1 + white*0.0750759;
        b2 = 0.96900*b2 + white*0.1538520;
        b3 = 0.86650*b3 + white*0.3104856;
        b4 = 0.55000*b4 + white*0.5329522;
        b5 = -0.7616*b5 - white*0.0168980;
        data[i] = (b0+b1+b2+b3+b4+b5+b6+white*0.5362) * 0.11;
        b6 = white * 0.115926;
      }
    }
    const filter = ctx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = 1200;
    filter.Q.value = 0.5;
    const source = ctx.createBufferSource();
    source.buffer = buffer;
    source.loop = true;
    source.connect(filter);
    filter.connect(gainNode);
    gainNode.connect(ctx.destination);
    source.start();
    bgNodes = { source, filter, gain: gainNode };
  }
  currentSound = type;
}

function stopBgSound() {
  if (bgNodes.source) {
    try { bgNodes.source.stop(); } catch(e) {}
  }
  bgNodes = {};
}

// ============================================
//  Notifications
// ============================================
function notify(msg) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('Pomo üçÖ', { body: msg, silent: true });
  }
}

// Request permission on first interaction
function requestNotifPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

// ============================================
//  Particles
// ============================================
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 25; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.top = (80 + Math.random() * 30) + '%';
    p.style.width = (1 + Math.random() * 3) + 'px';
    p.style.height = p.style.width;
    p.style.animationDuration = (8 + Math.random() * 16) + 's';
    p.style.animationDelay = Math.random() * 10 + 's';
    container.appendChild(p);
  }
}

// ============================================
//  Event Listeners
// ============================================
// Start/Pause
startBtn.addEventListener('click', () => {
  requestNotifPermission();
  startTimer();
});

// Spacebar
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && e.target.tagName !== 'SELECT') {
    e.preventDefault();
    requestNotifPermission();
    startTimer();
  }
});

// Mode tabs
document.querySelectorAll('.mode-tab').forEach(tab => {
  tab.addEventListener('click', () => switchMode(tab.dataset.mode));
});

// Language
document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentLang = btn.dataset.lang;
    updateUI();
    localStorage.setItem('pomo-lang', currentLang);
  });
});

// Theme
document.querySelectorAll('.theme-dot').forEach(dot => {
  dot.addEventListener('click', () => {
    document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
    dot.classList.add('active');
    document.body.setAttribute('data-theme', dot.dataset.t);
    localStorage.setItem('pomo-theme', dot.dataset.t);
  });
});

// Sound
document.getElementById('soundSelect').addEventListener('change', (e) => {
  generateNoise(e.target.value);
  localStorage.setItem('pomo-sound', e.target.value);
});

document.getElementById('soundVol').addEventListener('input', (e) => {
  if (bgNodes.gain) {
    bgNodes.gain.gain.value = (e.target.value / 100) * 0.3;
  }
  localStorage.setItem('pomo-vol', e.target.value);
});

// ============================================
//  Init
// ============================================
function init() {
  // Restore preferences
  const savedLang = localStorage.getItem('pomo-lang');
  if (savedLang && i18n[savedLang]) {
    currentLang = savedLang;
    document.querySelectorAll('.lang-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.lang === savedLang);
    });
  } else {
    // Auto-detect language
    const browserLang = navigator.language.slice(0, 2);
    if (browserLang === 'zh') currentLang = 'zh';
    else if (browserLang === 'ko') currentLang = 'ko';
    else currentLang = 'en';
    document.querySelectorAll('.lang-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.lang === currentLang);
    });
  }

  const savedTheme = localStorage.getItem('pomo-theme');
  if (savedTheme) {
    document.body.setAttribute('data-theme', savedTheme);
    document.querySelectorAll('.theme-dot').forEach(d => {
      d.classList.toggle('active', d.dataset.t === savedTheme);
    });
  }

  const savedVol = localStorage.getItem('pomo-vol');
  if (savedVol) document.getElementById('soundVol').value = savedVol;

  createParticles();
  updateDisplay();
  updateUI();
}

init();
</script>
</body>
</html>
