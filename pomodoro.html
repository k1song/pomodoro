<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Pomo ‚Äî Í∞êÏÑ± Ìè¨Î™®ÎèÑÎ°ú</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600&family=Noto+Sans+KR:wght@300;400;500&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg-primary: #1a1a2e; --bg-secondary: rgba(255,255,255,0.06);
  --text-primary: #f0e6d3; --text-secondary: rgba(240,230,211,0.5);
  --accent: #e8a87c; --accent-glow: rgba(232,168,124,0.3);
  --timer-size: min(270px, 58vw);
  --font-display: 'Outfit', sans-serif;
  --font-body: 'Outfit', 'Noto Sans KR', 'Noto Sans SC', sans-serif;
  --transition: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}
[data-theme="lofi"] { --bg-primary:#1a1a2e;--bg-secondary:rgba(255,255,255,0.06);--text-primary:#f0e6d3;--text-secondary:rgba(240,230,211,0.5);--accent:#e8a87c;--accent-glow:rgba(232,168,124,0.3); }
[data-theme="sunset"] { --bg-primary:#2d1b3d;--bg-secondary:rgba(255,255,255,0.08);--text-primary:#fde8d0;--text-secondary:rgba(253,232,208,0.5);--accent:#f0836d;--accent-glow:rgba(240,131,109,0.35); }
[data-theme="forest"] { --bg-primary:#1a2a1a;--bg-secondary:rgba(255,255,255,0.06);--text-primary:#e0ead4;--text-secondary:rgba(224,234,212,0.5);--accent:#8fbc8f;--accent-glow:rgba(143,188,143,0.3); }
[data-theme="black"] { --bg-primary:#050505;--bg-secondary:rgba(255,255,255,0.06);--text-primary:#e0e0e0;--text-secondary:rgba(224,224,224,0.4);--accent:#ffffff;--accent-glow:rgba(255,255,255,0.15); }

html, body { width:100%;height:100%;overflow:hidden;font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);transition:background var(--transition),color var(--transition);-webkit-font-smoothing:antialiased; }

.bg-layer { position:fixed;inset:0;z-index:0;transition:opacity var(--transition); }
[data-theme="lofi"] .bg-layer { background:radial-gradient(ellipse at 20% 50%,rgba(99,71,130,0.4) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(58,80,120,0.4) 0%,transparent 50%),radial-gradient(ellipse at 50% 100%,rgba(30,30,60,0.6) 0%,transparent 60%),linear-gradient(180deg,#0f0f23 0%,#1a1a2e 40%,#16213e 100%); }
[data-theme="sunset"] .bg-layer { background:radial-gradient(ellipse at 50% 110%,rgba(240,131,109,0.25) 0%,transparent 55%),radial-gradient(ellipse at 80% 30%,rgba(180,80,120,0.3) 0%,transparent 50%),radial-gradient(ellipse at 20% 60%,rgba(100,40,80,0.3) 0%,transparent 50%),linear-gradient(180deg,#1a0f25 0%,#2d1b3d 50%,#3d1f3f 100%); }
[data-theme="forest"] .bg-layer { background:radial-gradient(ellipse at 30% 70%,rgba(60,100,60,0.3) 0%,transparent 55%),radial-gradient(ellipse at 70% 30%,rgba(40,80,50,0.3) 0%,transparent 50%),radial-gradient(ellipse at 50% 100%,rgba(20,40,20,0.5) 0%,transparent 60%),linear-gradient(180deg,#0f1a0f 0%,#1a2a1a 50%,#1f301f 100%); }
[data-theme="black"] .bg-layer { background:radial-gradient(ellipse at 25% 40%,rgba(40,40,50,0.5) 0%,transparent 55%),radial-gradient(ellipse at 75% 65%,rgba(30,25,40,0.4) 0%,transparent 50%),linear-gradient(180deg,#080810 0%,#0a0a0a 50%,#050508 100%); }

.particles { position:fixed;inset:0;z-index:1;overflow:hidden;pointer-events:none; }
.particle { position:absolute;width:3px;height:3px;background:var(--text-primary);border-radius:50%;opacity:0;animation:float-up linear infinite; }
@keyframes float-up { 0%{opacity:0;transform:translateY(0) scale(0.5)} 10%{opacity:0.4} 90%{opacity:0.1} 100%{opacity:0;transform:translateY(-100vh) scale(0)} }

.app { position:relative;z-index:10;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px; }

.top-bar { position:fixed;top:0;left:0;right:0;z-index:100;display:flex;justify-content:space-between;align-items:center;padding:12px 20px; }
.top-right { display:flex;gap:8px;align-items:center; }
.glass { background:var(--bg-secondary);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px); }
.lang-switcher { display:flex;gap:3px;border-radius:10px;padding:4px; }
.lang-btn { background:none;border:none;color:var(--text-secondary);font-family:var(--font-body);font-size:11px;font-weight:500;padding:5px 10px;border-radius:7px;cursor:pointer;transition:all 0.3s;letter-spacing:0.02em; }
.lang-btn.active { background:var(--accent);color:var(--bg-primary); }
.theme-switcher { display:flex;gap:6px;border-radius:10px;padding:6px 10px; }
.theme-dot { width:16px;height:16px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all 0.3s;position:relative; }
.theme-dot::after { content:'';position:absolute;inset:2px;border-radius:50%; }
.theme-dot[data-t="lofi"]::after { background:linear-gradient(135deg,#667eea,#764ba2); }
.theme-dot[data-t="sunset"]::after { background:linear-gradient(135deg,#f0836d,#c06080); }
.theme-dot[data-t="forest"]::after { background:linear-gradient(135deg,#6dbb6d,#3a7a3a); }
.theme-dot[data-t="black"]::after { background:linear-gradient(135deg,#444450,#0a0a12); }
.theme-dot.active { border-color:var(--text-primary);transform:scale(1.15); }
.icon-btn { border:none;border-radius:10px;padding:8px;color:var(--text-secondary);cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center; }
.icon-btn:hover { color:var(--text-primary); }
.icon-btn svg { width:16px;height:16px; }

.mode-tabs { display:flex;gap:4px;border-radius:14px;padding:4px;margin-bottom:22px; }
.mode-tab { background:none;border:none;color:var(--text-secondary);font-family:var(--font-body);font-size:12px;font-weight:400;padding:8px 18px;border-radius:10px;cursor:pointer;transition:all 0.35s;white-space:nowrap; }
.mode-tab.active { background:var(--bg-secondary);color:var(--text-primary);font-weight:500; }

.timer-container { position:relative;width:var(--timer-size);height:var(--timer-size);margin-bottom:22px; }
.timer-ring { position:absolute;inset:0; }
.timer-ring svg { width:100%;height:100%;transform:rotate(-90deg); }
.timer-ring-bg { fill:none;stroke:var(--bg-secondary);stroke-width:3; }
.timer-ring-progress { fill:none;stroke:var(--accent);stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset 0.5s linear,stroke var(--transition);filter:drop-shadow(0 0 8px var(--accent-glow)); }
.timer-display { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px; }
.timer-time { font-family:var(--font-display);font-size:clamp(42px,11vw,68px);font-weight:200;letter-spacing:4px;line-height:1;color:var(--text-primary);transition:font-size 0.3s; }
.timer-time.long-fmt { font-size:clamp(34px,9vw,54px); }
.timer-label { font-size:11px;font-weight:400;letter-spacing:3px;text-transform:uppercase;color:var(--text-secondary); }
.timer-container.running .timer-time { text-shadow:0 0 40px var(--accent-glow); }
.timer-container.on-break .timer-ring-progress { animation:pulse-ring 2s ease-in-out infinite; }
@keyframes pulse-ring { 0%,100%{opacity:1} 50%{opacity:0.5} }

/* Countdown animation */
.timer-time.countdown { animation:countPop 0.4s ease-out; color:var(--accent); }
@keyframes countPop { 0%{transform:scale(1.4);opacity:0.5} 100%{transform:scale(1);opacity:1} }

.start-btn { background:none;border:1.5px solid var(--text-secondary);color:var(--text-primary);font-family:var(--font-body);font-size:14px;font-weight:400;letter-spacing:4px;text-transform:uppercase;padding:13px 44px;border-radius:50px;cursor:pointer;transition:all 0.4s;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);margin-bottom:18px; }
.start-btn:hover { border-color:var(--accent);color:var(--accent);box-shadow:0 0 30px var(--accent-glow);transform:translateY(-1px); }
.start-btn:active { transform:translateY(0) scale(0.98); }

.sound-control { display:flex;align-items:center;gap:8px;border-radius:12px;padding:7px 12px;margin-bottom:14px; }
.sound-icon { width:16px;height:16px;color:var(--text-secondary);flex-shrink:0; }
.sound-select { background:none;border:none;color:var(--text-secondary);font-family:var(--font-body);font-size:11px;cursor:pointer;appearance:none;-webkit-appearance:none;padding-right:14px;outline:none; }
.sound-select option { background:var(--bg-primary);color:var(--text-primary); }
.sound-vol { -webkit-appearance:none;appearance:none;width:50px;height:3px;background:var(--bg-secondary);border-radius:2px;outline:none;cursor:pointer; }
.sound-vol::-webkit-slider-thumb { -webkit-appearance:none;width:12px;height:12px;background:var(--accent);border-radius:50%;cursor:pointer; }

.todo-section { width:min(320px,85vw); }
.todo-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:6px; }
.todo-title { font-size:11px;font-weight:400;letter-spacing:2px;text-transform:uppercase;color:var(--text-secondary); }
.todo-add-btn { background:none;border:none;color:var(--text-secondary);font-size:18px;cursor:pointer;padding:0 4px;transition:color 0.3s;line-height:1; }
.todo-add-btn:hover { color:var(--accent); }
.todo-list { display:flex;flex-direction:column;gap:4px;max-height:160px;overflow-y:auto; }
.todo-list::-webkit-scrollbar { width:0; }
.todo-item { display:flex;align-items:center;gap:10px;border-radius:10px;padding:9px 12px;transition:all 0.3s;animation:slideIn 0.3s ease; }
@keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
.todo-check { width:16px;height:16px;border-radius:50%;border:1.5px solid var(--text-secondary);background:none;cursor:pointer;transition:all 0.3s;flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:0; }
.todo-check.done { border-color:var(--accent);background:var(--accent); }
.todo-check.done::after { content:'‚úì';font-size:9px;color:var(--bg-primary); }
.todo-text { flex:1;background:none;border:none;color:var(--text-primary);font-family:var(--font-body);font-size:13px;outline:none;min-width:0; }
.todo-text::placeholder { color:var(--text-secondary); }
.todo-text.done { text-decoration:line-through;color:var(--text-secondary); }
.todo-delete { background:none;border:none;color:var(--text-secondary);font-size:14px;cursor:pointer;padding:0 2px;opacity:0;transition:all 0.3s;line-height:1; }
.todo-item:hover .todo-delete { opacity:1; }
.todo-delete:hover { color:var(--accent); }

.daily-stats { position:fixed;bottom:14px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:5px; }
.pomo-dots { display:flex;gap:6px; }
.pomo-dot { width:8px;height:8px;border-radius:50%;background:var(--bg-secondary);transition:all 0.4s; }
.pomo-dot.filled { background:var(--accent);box-shadow:0 0 8px var(--accent-glow); }
.stats-text { font-size:11px;color:var(--text-secondary);letter-spacing:1px;display:flex;gap:12px; }
.stats-text span { display:flex;align-items:center;gap:4px; }

/* Settings Panel */
.overlay { position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.5);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity 0.3s; }
.overlay.open { opacity:1;pointer-events:all; }
.panel { position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.95);z-index:501;width:min(360px,90vw);background:var(--bg-primary);border:1px solid var(--bg-secondary);border-radius:20px;padding:26px 22px;opacity:0;pointer-events:none;transition:transform 0.3s,opacity 0.3s; }
.panel.open { opacity:1;pointer-events:all;transform:translate(-50%,-50%) scale(1); }
.panel-close { position:absolute;top:14px;right:14px;background:none;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer;line-height:1; }
.panel-close:hover { color:var(--text-primary); }
.panel-title { font-size:14px;font-weight:500;letter-spacing:2px;text-transform:uppercase;margin-bottom:22px;color:var(--text-primary); }
.s-group { margin-bottom:18px; }
.s-label { font-size:11px;font-weight:400;letter-spacing:2px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:10px; }
.s-row { display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px; }
.s-row > label { font-size:13px;color:var(--text-primary);flex-shrink:0;min-width:70px; }
.s-inputs { display:flex;align-items:center;gap:6px; }
.s-unit { font-size:11px;color:var(--text-secondary); }
.toggle { position:relative;width:40px;height:22px;background:var(--bg-secondary);border-radius:11px;border:none;cursor:pointer;transition:background 0.3s; }
.toggle::after { content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:var(--text-secondary);transition:all 0.3s; }
.toggle.on { background:var(--accent); }
.toggle.on::after { left:21px;background:var(--bg-primary); }

/* Stepper */
.stepper { display:flex;flex-direction:column;align-items:center;gap:2px; }
.stepper-group { display:flex;align-items:center;gap:2px; }
.stepper-val { width:38px;text-align:center;font-family:var(--font-display);font-size:18px;font-weight:300;color:var(--text-primary);background:none;border:none;outline:none; }
.stepper-btn { width:22px;height:22px;border-radius:6px;background:var(--bg-secondary);border:none;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all 0.2s;padding:0;line-height:1; }
.stepper-btn:hover { background:var(--accent);color:var(--bg-primary); }
.stepper-btn:active { transform:scale(0.9); }

.session-flash { position:fixed;inset:0;background:var(--accent);opacity:0;z-index:200;pointer-events:none;transition:opacity 0.15s; }
.session-flash.active { opacity:0.15; }

@media (max-width:480px) {
  .top-bar{padding:10px 14px} .lang-btn{font-size:10px;padding:4px 8px} .theme-dot{width:14px;height:14px}
  .mode-tab{padding:7px 14px;font-size:11px} .start-btn{padding:11px 36px;font-size:12px;letter-spacing:3px}
  :root{--timer-size:min(220px,55vw)} .timer-container{margin-bottom:16px} .mode-tabs{margin-bottom:16px}
  .stepper-val{font-size:16px;width:32px}
}
.app { animation:fadeIn 1s ease-out; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
::selection { background:var(--accent);color:var(--bg-primary); }
</style>
</head>
<body data-theme="lofi">
<div class="bg-layer"></div>
<div class="particles" id="particles"></div>
<div class="session-flash" id="sessionFlash"></div>

<div class="overlay" id="overlay"></div>
<div class="panel" id="panel">
  <button class="panel-close" id="panelClose">√ó</button>
  <div class="panel-title" data-i18n="settings">ÏÑ§Ï†ï</div>
  <div class="s-group">
    <div class="s-label" data-i18n="timerSettings">ÌÉÄÏù¥Î®∏</div>
    <!-- Focus: h + m -->
    <div class="s-row">
      <label data-i18n="focus">ÏßëÏ§ë</label>
      <div class="s-inputs">
        <div class="stepper-group">
          <button class="stepper-btn" data-target="setFocusH" data-dir="1">‚ñ≤</button>
          <span class="stepper-val" id="setFocusH">0</span>
          <button class="stepper-btn" data-target="setFocusH" data-dir="-1">‚ñº</button>
        </div>
        <span class="s-unit">h</span>
        <div class="stepper-group">
          <button class="stepper-btn" data-target="setFocusM" data-dir="1">‚ñ≤</button>
          <span class="stepper-val" id="setFocusM">25</span>
          <button class="stepper-btn" data-target="setFocusM" data-dir="-1">‚ñº</button>
        </div>
        <span class="s-unit">m</span>
      </div>
    </div>
    <!-- Short Break: m only -->
    <div class="s-row">
      <label data-i18n="shortBreak">ÏßßÏùÄ Ìú¥Ïãù</label>
      <div class="s-inputs">
        <div class="stepper-group">
          <button class="stepper-btn" data-target="setShortM" data-dir="1">‚ñ≤</button>
          <span class="stepper-val" id="setShortM">5</span>
          <button class="stepper-btn" data-target="setShortM" data-dir="-1">‚ñº</button>
        </div>
        <span class="s-unit">m</span>
      </div>
    </div>
    <!-- Long Break: h + m -->
    <div class="s-row">
      <label data-i18n="longBreak">Í∏¥ Ìú¥Ïãù</label>
      <div class="s-inputs">
        <div class="stepper-group">
          <button class="stepper-btn" data-target="setLongH" data-dir="1">‚ñ≤</button>
          <span class="stepper-val" id="setLongH">0</span>
          <button class="stepper-btn" data-target="setLongH" data-dir="-1">‚ñº</button>
        </div>
        <span class="s-unit">h</span>
        <div class="stepper-group">
          <button class="stepper-btn" data-target="setLongM" data-dir="1">‚ñ≤</button>
          <span class="stepper-val" id="setLongM">15</span>
          <button class="stepper-btn" data-target="setLongM" data-dir="-1">‚ñº</button>
        </div>
        <span class="s-unit">m</span>
      </div>
    </div>
  </div>
  <div class="s-group">
    <div class="s-label" data-i18n="optionsLabel">ÏòµÏÖò</div>
    <div class="s-row"><label data-i18n="autoStart">ÏûêÎèô ÏãúÏûë</label><button class="toggle" id="toggleAuto"></button></div>
  </div>
</div>

<div class="top-bar">
  <div class="lang-switcher glass">
    <button class="lang-btn active" data-lang="ko">ÌïúÍµ≠Ïñ¥</button>
    <button class="lang-btn" data-lang="en">EN</button>
    <button class="lang-btn" data-lang="zh">‰∏≠Êñá</button>
  </div>
  <div class="top-right">
    <div class="theme-switcher glass">
      <div class="theme-dot active" data-t="lofi"></div>
      <div class="theme-dot" data-t="sunset"></div>
      <div class="theme-dot" data-t="forest"></div>
      <div class="theme-dot" data-t="black"></div>
    </div>
    <button class="icon-btn glass" id="settingsBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
  </div>
</div>

<div class="app">
  <div class="mode-tabs glass">
    <button class="mode-tab active" data-mode="focus" data-i18n="focus">ÏßëÏ§ë</button>
    <button class="mode-tab" data-mode="short" data-i18n="shortBreak">ÏßßÏùÄ Ìú¥Ïãù</button>
    <button class="mode-tab" data-mode="long" data-i18n="longBreak">Í∏¥ Ìú¥Ïãù</button>
  </div>
  <div class="timer-container" id="timerContainer">
    <div class="timer-ring"><svg viewBox="0 0 320 320"><circle class="timer-ring-bg" cx="160" cy="160" r="150"/><circle class="timer-ring-progress" id="ringProgress" cx="160" cy="160" r="150" stroke-dasharray="942.48" stroke-dashoffset="0"/></svg></div>
    <div class="timer-display"><div class="timer-time" id="timerTime">25:00</div><div class="timer-label" id="timerLabel" data-i18n="ready">Ï§ÄÎπÑ</div></div>
  </div>
  <button class="start-btn" id="startBtn" data-i18n="start">ÏãúÏûë</button>
  <div class="sound-control glass">
    <svg class="sound-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 18V6l7-3v18l-7-3z"/><path d="M9 12H4m0-3v6"/></svg>
    <select class="sound-select" id="soundSelect">
      <option value="none" data-i18n-opt="soundNone">Î¨¥Ïùå</option>
      <option value="rain" data-i18n-opt="soundRain">ÎπóÏÜåÎ¶¨</option>
      <option value="cafe" data-i18n-opt="soundCafe">Ïπ¥Ìéò</option>
      <option value="fire" data-i18n-opt="soundFire">Î™®Îã•Î∂à</option>
      <option value="wave" data-i18n-opt="soundWave">ÌååÎèÑ</option>
      <option value="wind" data-i18n-opt="soundWind">Î∞îÎûå</option>
    </select>
    <input type="range" class="sound-vol" id="soundVol" min="0" max="100" value="40">
  </div>
  <div class="todo-section">
    <div class="todo-header"><div class="todo-title" data-i18n="tasks">Ìï† Ïùº</div><button class="todo-add-btn" id="todoAddBtn">+</button></div>
    <div class="todo-list" id="todoList"></div>
  </div>
</div>

<!-- 5 dots -->
<div class="daily-stats">
  <div class="pomo-dots" id="pomoDots"><div class="pomo-dot"></div><div class="pomo-dot"></div><div class="pomo-dot"></div><div class="pomo-dot"></div><div class="pomo-dot"></div></div>
  <div class="stats-text"><span>üçÖ <em id="pomoCountText">0</em></span><span>‚è± <em id="totalTimeText">0h 0m</em></span></div>
</div>

<script>
const i18n={ko:{focus:'ÏßëÏ§ë',shortBreak:'ÏßßÏùÄ Ìú¥Ïãù',longBreak:'Í∏¥ Ìú¥Ïãù',start:'ÏãúÏûë',pause:'ÏùºÏãúÏ†ïÏßÄ',resume:'Í≥ÑÏÜç',cancel:'Ï∑®ÏÜå',ready:'Ï§ÄÎπÑ',focusing:'ÏßëÏ§ë Ï§ë',breaking:'Ìú¥Ïãù Ï§ë',countdown:'Í≥ß ÏãúÏûë',soundNone:'Î¨¥Ïùå',soundRain:'ÎπóÏÜåÎ¶¨',soundCafe:'Ïπ¥Ìéò',soundFire:'Î™®Îã•Î∂à',soundWave:'ÌååÎèÑ',soundWind:'Î∞îÎûå',sessionDone:'ÏÑ∏ÏÖò ÏôÑÎ£å!',breakDone:'Ìú¥Ïãù ÎÅù! Îã§Ïãú ÏßëÏ§ëÌïòÏÑ∏Ïöî',tabFocus:'ÏßëÏ§ë Ï§ë',tabBreak:'Ìú¥Ïãù Ï§ë',tasks:'Ìï† Ïùº',taskPH:'Ìï† ÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...',settings:'ÏÑ§Ï†ï',timerSettings:'ÌÉÄÏù¥Î®∏',optionsLabel:'ÏòµÏÖò',autoStart:'ÏûêÎèô ÏãúÏûë'},en:{focus:'Focus',shortBreak:'Short Break',longBreak:'Long Break',start:'Start',pause:'Pause',resume:'Resume',cancel:'Cancel',ready:'Ready',focusing:'Focusing',breaking:'On Break',countdown:'Starting',soundNone:'Silent',soundRain:'Rain',soundCafe:'Caf√©',soundFire:'Fire',soundWave:'Waves',soundWind:'Wind',sessionDone:'Session done!',breakDone:'Break over! Time to focus',tabFocus:'Focus',tabBreak:'Break',tasks:'Tasks',taskPH:'Add a task...',settings:'Settings',timerSettings:'Timer',optionsLabel:'Options',autoStart:'Auto Start'},zh:{focus:'‰∏ìÊ≥®',shortBreak:'Áü≠‰ºëÊÅØ',longBreak:'Èïø‰ºëÊÅØ',start:'ÂºÄÂßã',pause:'ÊöÇÂÅú',resume:'ÁªßÁª≠',cancel:'ÂèñÊ∂à',ready:'ÂáÜÂ§á',focusing:'‰∏ìÊ≥®‰∏≠',breaking:'‰ºëÊÅØ‰∏≠',countdown:'Âç≥Â∞ÜÂºÄÂßã',soundNone:'ÈùôÈü≥',soundRain:'Èõ®Â£∞',soundCafe:'ÂíñÂï°ÂéÖ',soundFire:'ÁØùÁÅ´',soundWave:'Êµ∑Êµ™',soundWind:'È£éÂ£∞',sessionDone:'ÂÆåÊàêÔºÅ',breakDone:'‰ºëÊÅØÁªìÊùüÔºÅÁªßÁª≠‰∏ìÊ≥®',tabFocus:'‰∏ìÊ≥®',tabBreak:'‰ºëÊÅØ',tasks:'‰ªªÂä°',taskPH:'ËæìÂÖ•‰ªªÂä°...',settings:'ËÆæÁΩÆ',timerSettings:'ËÆ°Êó∂Âô®',optionsLabel:'ÈÄâÈ°π',autoStart:'Ëá™Âä®ÂºÄÂßã'}};

let lang='ko';const TITLE='Pomo';
function t(k){return i18n[lang]?.[k]||k}
function updateUI(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(i18n[lang]?.[k])el.textContent=i18n[lang][k]});
  document.querySelectorAll('[data-i18n-opt]').forEach(el=>{const k=el.getAttribute('data-i18n-opt');if(i18n[lang]?.[k])el.textContent=i18n[lang][k]});
  document.querySelectorAll('.todo-text').forEach(el=>el.placeholder=t('taskPH'));
  if(counting)return;
  if(!running&&!paused){$label.textContent=t('ready');$start.textContent=t('start');document.title=TITLE}
  else if(paused)$start.textContent=t('resume');
  else{updLabel();$start.textContent=t('pause')}
}

let MODES={focus:25*60,short:5*60,long:15*60},mode='focus',left=MODES.focus,total=MODES.focus;
let running=false,paused=false,counting=false,intv=null,countIntv=null,pCount=0,focusSec=0,autoOn=false,todos=[];

const $time=document.getElementById('timerTime'),$label=document.getElementById('timerLabel');
const $box=document.getElementById('timerContainer'),$start=document.getElementById('startBtn');
const $ring=document.getElementById('ringProgress'),$dots=document.getElementById('pomoDots');
const $pCount=document.getElementById('pomoCountText'),$tTime=document.getElementById('totalTimeText');
const $flash=document.getElementById('sessionFlash');
const C=2*Math.PI*150;$ring.style.strokeDasharray=C;

// Format: >= 3600s ‚Üí "1:05:30", < 3600s ‚Üí "25:00"
function fmt(s){
  if(s>=3600){
    const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
    return`${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  }
  return`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}
function updDisp(){
  $time.textContent=fmt(left);
  $time.classList.toggle('long-fmt',left>=3600);
  $ring.style.strokeDashoffset=C*(left/total);
  if(running&&!paused)document.title=`${fmt(left)} ‚Äî ${mode==='focus'?t('tabFocus'):t('tabBreak')}`;
}
function updLabel(){$label.textContent=mode==='focus'?t('focusing'):t('breaking')}
function updStats(){$pCount.textContent=pCount;const h=Math.floor(focusSec/3600),m=Math.floor((focusSec%3600)/60);$tTime.textContent=`${h}h ${m}m`}
function updDots(){
  const ds=$dots.querySelectorAll('.pomo-dot'),c=pCount%5;
  ds.forEach((d,i)=>d.classList.toggle('filled',i<(c===0&&pCount>0?5:c)));
  if(c===0&&pCount>0)setTimeout(()=>ds.forEach(d=>d.classList.remove('filled')),2000);
}

// === 5-second countdown ===
function startCountdown(cb){
  counting=true;let sec=5;
  $start.textContent=t('cancel');
  $label.textContent=t('countdown');
  $box.classList.add('running');
  function show(){
    $time.textContent=sec;
    $time.classList.remove('countdown');
    void $time.offsetWidth; // reflow
    $time.classList.add('countdown');
  }
  show();
  countIntv=setInterval(()=>{
    sec--;
    if(sec>0){show();return}
    // sec === 0: show "ÏãúÏûë" text briefly then begin
    clearInterval(countIntv);countIntv=null;counting=false;
    $time.classList.remove('countdown');
    cb();
  },1000);
}
function cancelCountdown(){
  if(countIntv){clearInterval(countIntv);countIntv=null}
  counting=false;
  $box.classList.remove('running','on-break');
  $time.classList.remove('countdown','long-fmt');
  updDisp();
  $start.textContent=t('start');
  $label.textContent=t('ready');
  document.title=TITLE;
}

function go(){
  // Cancel countdown if active
  if(counting){cancelCountdown();return}
  // Resume from pause
  if(paused){paused=false;running=true;$start.textContent=t('pause');intv=setInterval(tick,1000);return}
  // Pause
  if(running){paused=true;running=false;clearInterval(intv);$start.textContent=t('resume');document.title=`‚è∏ ${fmt(left)}`;return}
  // Start fresh ‚Üí countdown first
  startCountdown(()=>{
    running=true;paused=false;
    $start.textContent=t('pause');
    $box.classList.add('running');
    if(mode!=='focus')$box.classList.add('on-break');
    updLabel();updDisp();
    intv=setInterval(tick,1000);
  });
}

function tick(){
  left--;if(mode==='focus')focusSec++;updDisp();updStats();
  if(left<=0){clearInterval(intv);running=false;paused=false;$box.classList.remove('running','on-break');
    $flash.classList.add('active');setTimeout(()=>$flash.classList.remove('active'),400);alarm();
    if(mode==='focus'){pCount++;updDots();saveDay();notify(t('sessionDone'));setMode(pCount%5===0?'long':'short')}
    else{notify(t('breakDone'));setMode('focus')}
    $start.textContent=t('start');$label.textContent=t('ready');document.title=TITLE;
    if(autoOn)setTimeout(go,1500);
  }
}
function setMode(m){mode=m;left=MODES[m];total=MODES[m];clearInterval(intv);running=false;paused=false;
  if(counting)cancelCountdown();
  $box.classList.remove('running','on-break');updDisp();
  document.querySelectorAll('.mode-tab').forEach(t=>t.classList.toggle('active',t.dataset.mode===m));
  $start.textContent=t('start');$label.textContent=t('ready');document.title=TITLE;
}

// Daily persistence
function dayKey(){return'pomo-'+new Date().toISOString().slice(0,10)}
function saveDay(){localStorage.setItem(dayKey(),JSON.stringify({c:pCount,s:focusSec}))}
function loadDay(){const d=localStorage.getItem(dayKey());if(d){const p=JSON.parse(d);pCount=p.c||0;focusSec=p.s||0}updDots();updStats()}

// Todos
function renderTodos(){const el=document.getElementById('todoList');el.innerHTML='';
  todos.forEach((td,i)=>{const d=document.createElement('div');d.className='todo-item glass';
    d.innerHTML=`<button class="todo-check ${td.done?'done':''}" data-i="${i}"></button><input class="todo-text ${td.done?'done':''}" value="${td.text.replace(/"/g,'&quot;')}" placeholder="${t('taskPH')}" data-i="${i}"><button class="todo-delete" data-i="${i}">√ó</button>`;
    el.appendChild(d)});saveTodos()}
function saveTodos(){localStorage.setItem('pomo-todos',JSON.stringify(todos))}
function loadTodos(){const d=localStorage.getItem('pomo-todos');if(d)todos=JSON.parse(d);renderTodos()}
document.getElementById('todoList').addEventListener('click',e=>{const i=+e.target.dataset.i;if(isNaN(i))return;
  if(e.target.classList.contains('todo-check')){todos[i].done=!todos[i].done;renderTodos()}
  else if(e.target.classList.contains('todo-delete')){todos.splice(i,1);renderTodos()}});
document.getElementById('todoList').addEventListener('input',e=>{if(e.target.classList.contains('todo-text')){const i=+e.target.dataset.i;if(!isNaN(i)){todos[i].text=e.target.value;saveTodos()}}});
document.getElementById('todoAddBtn').addEventListener('click',()=>{if(todos.length>=5)return;todos.push({text:'',done:false});renderTodos();const ins=document.querySelectorAll('.todo-text');ins[ins.length-1]?.focus()});

// Audio: alarm
let actx;function getCtx(){if(!actx)actx=new(window.AudioContext||window.webkitAudioContext);return actx}
function alarm(){try{const c=getCtx(),n=c.currentTime;[440,554,659].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(0,n+i*.3);g.gain.linearRampToValueAtTime(.15,n+i*.3+.05);g.gain.exponentialRampToValueAtTime(.001,n+i*.3+.8);o.connect(g);g.connect(c.destination);o.start(n+i*.3);o.stop(n+i*.3+.8)})}catch(e){}}

// Audio: background
let bgCtx,bgN={};
function genSound(type){if(!bgCtx)bgCtx=new(window.AudioContext||window.webkitAudioContext);
  if(bgN.s){try{bgN.s.stop()}catch(e){}}bgN={};if(type==='none')return;
  const c=bgCtx,sr=c.sampleRate,len=sr*4,buf=c.createBuffer(2,len,sr),gn=c.createGain();
  gn.gain.value=(document.getElementById('soundVol').value/100)*0.3;
  const cfg={rain:{g:'b',ft:'lowpass',f:800,q:1},cafe:{g:'p',ft:'bandpass',f:1200,q:0.5},fire:{g:'b',ft:'lowpass',f:400,q:0.8},wave:{g:'b',ft:'lowpass',f:500,q:0.6},wind:{g:'p',ft:'lowpass',f:600,q:0.7}}[type];
  if(!cfg)return;
  for(let ch=0;ch<2;ch++){const d=buf.getChannelData(ch);
    if(cfg.g==='b'){let l=0;for(let i=0;i<len;i++){const w=Math.random()*2-1;d[i]=(l+.02*w)/1.02;l=d[i];d[i]*=3.5}}
    else{let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;for(let i=0;i<len;i++){const w=Math.random()*2-1;b0=.99886*b0+w*.0555179;b1=.99332*b1+w*.0750759;b2=.96900*b2+w*.1538520;b3=.86650*b3+w*.3104856;b4=.55000*b4+w*.5329522;b5=-.7616*b5-w*.0168980;d[i]=(b0+b1+b2+b3+b4+b5+b6+w*.5362)*.11;b6=w*.115926}}}
  const fl=c.createBiquadFilter();fl.type=cfg.ft;fl.frequency.value=cfg.f;fl.Q.value=cfg.q;
  const s=c.createBufferSource();s.buffer=buf;s.loop=true;s.connect(fl);fl.connect(gn);gn.connect(c.destination);s.start();bgN={s,f:fl,g:gn}}

function notify(m){if('Notification'in window&&Notification.permission==='granted')new Notification('Pomo üçÖ',{body:m,silent:true})}
function reqNotif(){if('Notification'in window&&Notification.permission==='default')Notification.requestPermission()}
function mkParticles(){const c=document.getElementById('particles');for(let i=0;i<25;i++){const p=document.createElement('div');p.className='particle';p.style.left=Math.random()*100+'%';p.style.top=(80+Math.random()*30)+'%';p.style.width=(1+Math.random()*3)+'px';p.style.height=p.style.width;p.style.animationDuration=(8+Math.random()*16)+'s';p.style.animationDelay=Math.random()*10+'s';c.appendChild(p)}}

// === Settings with steppers ===
const $ov=document.getElementById('overlay'),$pn=document.getElementById('panel'),$ta=document.getElementById('toggleAuto');
const stepEls={setFocusH:document.getElementById('setFocusH'),setFocusM:document.getElementById('setFocusM'),setShortM:document.getElementById('setShortM'),setLongH:document.getElementById('setLongH'),setLongM:document.getElementById('setLongM')};

// Stepper limits: {min, max, step}
const stepCfg={setFocusH:{min:0,max:2,step:1},setFocusM:{min:0,max:55,step:5},setShortM:{min:1,max:30,step:5},setLongH:{min:0,max:2,step:1},setLongM:{min:0,max:55,step:5}};

document.querySelectorAll('.stepper-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const id=btn.dataset.target, dir=+btn.dataset.dir, cfg=stepCfg[id], el=stepEls[id];
    let v=parseInt(el.textContent)||0;
    v+=dir*cfg.step;
    // Clamp
    if(v>cfg.max)v=cfg.max; if(v<cfg.min)v=cfg.min;
    // Ensure at least 1 min total for focus/long
    el.textContent=v;
    validateMinTotal();
  });
});

function validateMinTotal(){
  // Focus must be >= 1 min total
  const fh=+(stepEls.setFocusH.textContent)||0, fm=+(stepEls.setFocusM.textContent)||0;
  if(fh===0&&fm===0)stepEls.setFocusM.textContent=5;
  // Short must be >= 1
  if(+(stepEls.setShortM.textContent)<1)stepEls.setShortM.textContent=1;
  // Long must be >= 1 min total
  const lh=+(stepEls.setLongH.textContent)||0, lm=+(stepEls.setLongM.textContent)||0;
  if(lh===0&&lm===0)stepEls.setLongM.textContent=5;
}

document.getElementById('settingsBtn').addEventListener('click',()=>{$ov.classList.add('open');$pn.classList.add('open')});
function closePanel(){$ov.classList.remove('open');$pn.classList.remove('open');applySettings()}
document.getElementById('panelClose').addEventListener('click',closePanel);$ov.addEventListener('click',closePanel);
$ta.addEventListener('click',()=>{autoOn=!autoOn;$ta.classList.toggle('on',autoOn);localStorage.setItem('pomo-auto',autoOn)});

function applySettings(){
  validateMinTotal();
  const fh=+(stepEls.setFocusH.textContent)||0, fm=+(stepEls.setFocusM.textContent)||0;
  const sm=+(stepEls.setShortM.textContent)||5;
  const lh=+(stepEls.setLongH.textContent)||0, lm=+(stepEls.setLongM.textContent)||0;
  const focusMin=fh*60+fm, shortMin=sm, longMin=lh*60+lm;
  MODES={focus:focusMin*60,short:shortMin*60,long:longMin*60};
  localStorage.setItem('pomo-modes',JSON.stringify({fh,fm,sm,lh,lm}));
  if(!running&&!paused&&!counting){left=MODES[mode];total=MODES[mode];updDisp()}
}

// Events
$start.addEventListener('click',()=>{reqNotif();go()});
document.addEventListener('keydown',e=>{if(e.code==='Space'&&!['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)){e.preventDefault();reqNotif();go()}});
document.querySelectorAll('.mode-tab').forEach(t=>t.addEventListener('click',()=>setMode(t.dataset.mode)));
document.querySelectorAll('.lang-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.lang-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');lang=b.dataset.lang;updateUI();localStorage.setItem('pomo-lang',lang)}));
document.querySelectorAll('.theme-dot').forEach(d=>d.addEventListener('click',()=>{document.querySelectorAll('.theme-dot').forEach(x=>x.classList.remove('active'));d.classList.add('active');document.body.setAttribute('data-theme',d.dataset.t);localStorage.setItem('pomo-theme',d.dataset.t)}));
document.getElementById('soundSelect').addEventListener('change',e=>{genSound(e.target.value);localStorage.setItem('pomo-sound',e.target.value)});
document.getElementById('soundVol').addEventListener('input',e=>{if(bgN.g)bgN.g.gain.value=(e.target.value/100)*0.3;localStorage.setItem('pomo-vol',e.target.value)});

// Init
(function init(){
  const sL=localStorage.getItem('pomo-lang');
  if(sL&&i18n[sL])lang=sL;else{const b=navigator.language.slice(0,2);lang=b==='zh'?'zh':b==='ko'?'ko':'en'}
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.dataset.lang===lang));
  const sT=localStorage.getItem('pomo-theme');
  if(sT){document.body.setAttribute('data-theme',sT);document.querySelectorAll('.theme-dot').forEach(d=>d.classList.toggle('active',d.dataset.t===sT))}
  const sV=localStorage.getItem('pomo-vol');if(sV)document.getElementById('soundVol').value=sV;
  const sS=localStorage.getItem('pomo-sound');if(sS)document.getElementById('soundSelect').value=sS;
  const sM=localStorage.getItem('pomo-modes');
  if(sM){
    const m=JSON.parse(sM);
    // Support both old format {f,s,l} and new {fh,fm,sm,lh,lm}
    if(m.fh!==undefined){
      stepEls.setFocusH.textContent=m.fh||0;stepEls.setFocusM.textContent=m.fm||0;
      stepEls.setShortM.textContent=m.sm||5;
      stepEls.setLongH.textContent=m.lh||0;stepEls.setLongM.textContent=m.lm||0;
      MODES={focus:((m.fh||0)*60+(m.fm||0))*60,short:(m.sm||5)*60,long:((m.lh||0)*60+(m.lm||0))*60};
    } else {
      // Old format: f=totalMin, s=totalMin, l=totalMin
      const fh=Math.floor((m.f||25)/60),fm=(m.f||25)%60;
      const lh=Math.floor((m.l||15)/60),lm=(m.l||15)%60;
      stepEls.setFocusH.textContent=fh;stepEls.setFocusM.textContent=fm;
      stepEls.setShortM.textContent=m.s||5;
      stepEls.setLongH.textContent=lh;stepEls.setLongM.textContent=lm;
      MODES={focus:(m.f||25)*60,short:(m.s||5)*60,long:(m.l||15)*60};
    }
    left=MODES.focus;total=MODES.focus;
  }
  autoOn=localStorage.getItem('pomo-auto')==='true';$ta.classList.toggle('on',autoOn);
  loadDay();loadTodos();mkParticles();updDisp();updateUI()})();
</script>
</body>
</html>
